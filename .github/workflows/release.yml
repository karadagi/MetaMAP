name: Build and Release MetaMAP

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Get version from csproj
        id: get_version
        run: |
          [xml]$csproj = Get-Content "MetaMAP.csproj"
          $version = $csproj.Project.PropertyGroup.Version | Select-Object -First 1
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=v$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Check if release exists
        id: check_release
        uses: actions/github-script@v6
        with:
          script: |
            const version = process.env.VERSION;
            const tag = `v${version}`;
            const { data: releases } = await github.repos.listReleases({owner: context.repo.owner, repo: context.repo.repo});
            const exists = releases.some(r => r.tag_name === tag);
            core.setOutput('EXISTS', exists);
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}

      - name: Create Release
        if: steps.check_release.outputs.EXISTS == 'false'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.TAG }}
          release_name: MetaMAP v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            MetaMAP version ${{ steps.get_version.outputs.VERSION }}

      - name: Upload Release Asset
        if: steps.check_release.outputs.EXISTS == 'false'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./bin/Release/net8.0-windows/MetaMAP_Manual_New.zip
          asset_name: MetaMAP_Manual_New.zip
          asset_content_type: application/zip
