name: Build and Release MetaMAP

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --configuration Release --no-restore
      
    - name: Get version from csproj
      id: get_version
name: Build and Release MetaMAP

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --configuration Release --no-restore
      
    - name: Get version from csproj
      id: get_version
      run: |
        [xml]$csproj = Get-Content "MetaMAP.csproj"
        $version = $csproj.Project.PropertyGroup.Version | Select-Object -First 1
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=v$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    ${{ secrets.GITHUB_TOKEN }}
      
    - name: Check if release exists
      id: check_release
      run: |
        $tag = "v${{ steps.get_version.outputs.VERSION }}"
        $exists = gh release view $tag 2>&1
        if ($LASTEXITCODE -eq 0) {
          echo "EXISTS=true" >> $env:GITHUB_OUTPUT
        } else {
          echo "EXISTS=false" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Create Release
      if: steps.check_release.outputs.EXISTS == 'false'
      id: create_release
      run: |
        $tag = "v${{ steps.get_version.outputs.VERSION }}"
        gh release create $tag `
          --title "MetaMAP v${{ steps.get_version.outputs.VERSION }}" `
          --notes "MetaMAP version ${{ steps.get_version.outputs.VERSION }}`n`n## Installation`n1. Download MetaMAP_Manual_New.zip`n2. Extract all files to your Grasshopper Components folder`n3. Restart Rhino" `
          ./bin/Release/net8.0-windows/MetaMAP_Manual_New.zip
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
